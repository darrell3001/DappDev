<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Simple Counter </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>


<body>
    <div>
        <p id='counter-value'></p>
        <button id='increment'>Increment</button>
        <button id='decrement'>Decrement</button>
        <button id='reset'>Reset</button>
        <p id='status'>Idle</p>
        <p id='last-transaction-status'></p>
        <p id='timerpop'>0</p> 
        <p id='asyncpop'>0</p> 
        <p id='xyz'>0</p> 
    </div>

    <link rel="stylesheet" type="text/css" href="/style/main.css">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js" integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>

    <!-- 0.20.6 Link  -->
    <!-- <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>  -->
    <!-- 1.0 Link  -->
    <!-- <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js" integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>  -->
    <!-- 1.0 Local  -->
    <!-- <script src="/script/web3.min-1.0.js"></script>  -->
    <!-- 0.20.6 Local  -->
    <!-- <script src="/script/web3.min-0.20.js"></script>  -->


    <script>


        function initContract() {
            web3 = new Web3(web3.currentProvider); 

            var address = '0x44f0d7d69aadcb38ca1de6dea02faf080119fa5e';
            var abi = [
                        {
                            "constant": false,
                            "inputs": [],
                            "name": "decrement",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [],
                            "name": "increment",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [],
                            "name": "reset",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "constructor"
                        },
                        {
                            "anonymous": false,
                            "inputs": [
                                {
                                    "indexed": false,
                                    "name": "newCounterValue",
                                    "type": "int256"
                                }
                            ],
                            "name": "counterUpdated",
                            "type": "event"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "getCounter",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "int256"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        }
                    ];

            contract = new web3.eth.Contract(abi, address);
        }

        function getValue() {
            contract.methods.getCounter().call().then((result) => {
                $('#counter-value').html(result);
            })
        }

        function isMobile() {
            return (/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ); 
        }

        function mobileDeviceRefreshValue() {
//    if (!isWaitingForConsensus) {
//                var curr = parseInt($('#timerpop').html());
//                $('#timerpop').html(curr + 1);
//                getValue();
//            }

            var status = $('#status').html();
            if (status !== "waiting for consensus") {
                var curr = parseInt($('#timerpop').html());
                $('#timerpop').html(curr + 1);
                getValue();
            }
        }


// main()
        var contract;
        var events;
        var isWaitingForConsensus = false;
        var timerPops = 0;

        $(document).ready(function() {
            initContract();
            getValue();

            isMobileDevice = isMobile();
            isMobileDevice = false;

            if (isMobileDevice) {
                // Mobile device cant do async so just update value in place on interval 
                // Initialzie the Promise then move on
                setInterval(function(){ mobileDeviceRefreshValue(); }, 5000);
            } else {
                contract.events.counterUpdated((error, event) => { 
                    var curr = parseInt($('#asyncpop').html());
                    $('#asyncpop').html(curr + 1);
//                    $('#counter-value').html(event.returnValues.newCounterValue);
                    $('#xyz').html("hiyall1");
                })
            }

        })

        $('#increment').click(function() {
            web3.eth.getAccounts().then(function(accounts) {
                $('#status').html("waiting for consensus");
                $('#last-transaction-status').html("");
                var acct = accounts[0];
                return contract.methods.increment().send({from: acct});
            }).then(function(tx) {
                if (isMobileDevice) { getValue() }  // Mobile device cant do async so just update value in place  
                $('#status').html("idle");
                $('#last-transaction-status').html("last transaction was successful");
            }).catch(function(err) {
                $('#status').html("idle");
                $('#last-transaction-status').html("last transaction failed");
                console.log(err);
            })
        })

        $('#decrement').click(function() {
            web3.eth.getAccounts().then(function(accounts) {
                $('#status').html("waiting for consensus");
                $('#last-transaction-status').html("");
                var acct = accounts[0];
                return contract.methods.decrement().send({from: acct});
            }).then(function(tx) {
                if (isMobileDevice) { getValue() }  // Mobile device cant do async so just update value in place  
                $('#status').html("idle");
                $('#last-transaction-status').html("last transaction was successful");
            }).catch(function(err) {
                $('#status').html("idle");
                $('#last-transaction-status').html("last transaction failed");
                console.log(err);
            })
        })

        $('#reset').click(function() {
            web3.eth.getAccounts().then(function(accounts) {
                $('#status').html("waiting for consensus");
                $('#last-transaction-status').html("");
                var acct = accounts[0];
                return contract.methods.reset().send({from: acct});
            }).then(function(tx) {
                if (isMobileDevice) { getValue() }  // Mobile device cant do async so just update value in place  
                $('#status').html("idle");
                $('#last-transaction-status').html("last transaction was successful");
            }).catch(function(err) {
                $('#status').html("idle");
                $('#last-transaction-status').html("last transaction failed");
                console.log(err);
            })
        })

    </script>

</body>
</html>